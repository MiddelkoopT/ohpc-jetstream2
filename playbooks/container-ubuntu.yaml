- name: Build Ubuntu Container
  hosts: head
  become: true
  tasks:
    - name: Generate compute node image -- UNTESTED AFTER REFACTORING
      ansible.builtin.shell: |
        set -e
        sms_ip=10.5.0.8

        ## Import node image
        wwctl container import docker://registry.docker.com/library/ubuntu:24.04 ubuntu-24.04
        wwctl container syncuser ubuntu-24.04 --write # set head uid/gid in container before install
        wwctl overlay build

        ## Build and configure node
        wwctl container exec --syncuser ubuntu-24.04 /bin/bash <<-EOF
          ## Debug
          passwd -d root # allow serial console login

          ## Update image
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install --yes apt-utils
          apt-get dist-upgrade --yes

          ## Install kernel
          apt-get install --yes --no-install-recommends linux-image-generic linux-tools-generic
          rm -v /initrd.img* /vmlinuz*

          ## Install base packages
          apt-get install --yes --no-install-recommends curl jq zstd cpio procps iproute2 busybox-static
          apt-get install --yes --no-install-recommends init udev dbus polkitd
          apt-get install --yes --no-install-recommends systemd-timesyncd systemd-resolved
          apt-get install --yes --no-install-recommends openssh-server python3
          apt-get install --yes less vim

          ## Network
          systemctl enable systemd-networkd
          cat > /etc/systemd/network/en.network <<-CONF
            [Match]
            Name=en*

            [Network]
            DHCP=yes
            LinkLocalAddressing=ipv6
          CONF

          wwctl overlay mkdir wwinit /etc/systemd/network
          wwctl overlay import wwinit en.network /etc/systemd/network/en.network

          mount -t devpts devpts /dev/pts ## workarround
          install -dv --mode=700 --owner=munge --group=munge /etc/munge
          touch /etc/munge/munge.key ## blank file will be replace with the overlay (bypass container install error)
          apt-get install --yes munge
          systemctl enable munge
          umount /dev/pts ## workarround

          apt-get install --yes slurmd
          echo SLURMD_OPTIONS="--conf-server ${sms_ip}" > /etc/default/slurmd
          systemctl enable slurmd

          apt-get install --yes lmod

          ## Cleanup
          apt-get clean

          echo "exit container"
        EOF

        ## fix init hack
        #perl -pi -e 's/#!\/bin\/sh/\/bin\/bash/' /var/lib/warewulf/overlays/wwinit/rootfs/init

        wwctl profile set --yes default --kernelargs="crashkernel=no vga=791 net.naming-scheme=v238"

      args:
        creates: /var/lib/warewulf/provision/container/ubuntu-24-04.img.gz
